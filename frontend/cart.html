<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dab Dab - Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #fff7ed;
      margin: 0;
      padding: 80px 0 120px;
    }

    header {
      position: fixed;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      height: 70px;
      background-color: #f97316;
      top: 0;
      left: 0;
    }

    .logo img {
      width: 130px;
      margin-left: 20px;
    }

    a i {
      font-size: 1.5rem;
    }

    header p {
      color: white;
      position: absolute;
      right: 0;
      margin-right: 20px;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .cart-container {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .cart-item {
      text-align: center;
      width: 95%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      margin-bottom: 16px;
      padding: 10px 5px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .cart-item img {
      width: 110px;
      height: 110px;
      border-radius: 10px;
      object-fit: cover;
      margin-right: 12px;
    }


    .cart-item h3 {
      font-size: 1.3rem;
      margin: 0 0 4px;
      color: #222;
    }

    .cart-item p {
      font-size: 0.9rem;
      color: #555;
      margin: 0;
    }

    .extra-details .price {
      color: #f97316;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .name-details {
      display: flex;
      align-items: center;
      flex-direction: column;
    }

    .extra-details {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .qty-controls {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }

    .qty-controls button {
      background: #f97316;
      border: none;
      color: white;
      width: 25px;
      height: 25px;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
    }

    .qty-controls span {
      margin: 0 10px;
      font-weight: 600;
    }

    .cart-summary {
      background: white;
      padding:20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-top: 30px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .summary-row strong {
      font-weight: 600;
    }

    .checkout-btn {
      width: 100%;
      background: #f97316;
      color: white;
      padding: 14px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      margin-top: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .checkout-btn:disabled {
      background: #fea565d4;
      cursor: not-allowed;
    }

    .empty-msg {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-direction: column;
      color: #888;
      font-size: 1rem;
      margin-top: 40px;
    }

    .empty-msg .additems {
      text-decoration: none;
      color: #fff7ed;
      background-color: #f97316;
      padding: 15px 20px;
      border-radius: 10px;
      cursor: pointer;
    }

    /* Loader Overlay */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 247, 237, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loader {
      width: 40px;
      height: 40px;
      border: 6px solid #fff;
      border-top: 6px solid #f97316;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><img src="Assets/dabdab.jpg" alt="Dab Dab"></div>
    <p onclick="home()"><i class='bx bx-home'></i></p>
  </header>

  <!-- Loader -->
  <div class="loader-overlay" id="loaderOverlay">
    <div class="loader"></div>
  </div>

  <div class="cart-container" id="cartContainer"></div>

  <div class="cart-container">
    <div class="cart-summary">
      <div class="summary-row">
        <span>Subtotal</span>
        <span id="subtotal">₹0</span>
      </div>
      <div class="summary-row">
        <span>Delivery</span>
        <span id="delivery">₹0</span>
      </div>
      <div class="summary-row">
        <strong>Total</strong>
        <strong id="total">₹0</strong>
      </div>
      <button class="checkout-btn" id="checkoutBtn" disabled>Proceed to Checkout</button>
    </div>
  </div>

  <script>
    const cartContainer = document.getElementById('cartContainer');
    const subtotalEl = document.getElementById('subtotal');
    const deliveryEl = document.getElementById('delivery');
    const totalEl = document.getElementById('total');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const loaderOverlay = document.getElementById('loaderOverlay');

    async function loadCart() {
      loaderOverlay.style.display = 'flex'; // Show loader
      try {
        const res = await fetch('https://dab-1.onrender.com/api/cart', { credentials: 'include' });
        if (res.status === 401) {
          cartContainer.innerHTML = `
            <div class="empty-msg">
              <p>Please login to view your cart.</p>
              <p class="additems" onclick="signin()">Login</p>
            </div>`;
          subtotalEl.textContent = '₹0';
          deliveryEl.textContent = '₹0';
          totalEl.textContent = '₹0';
          checkoutBtn.disabled = true;
          return;
        }

        const data = await res.json();
        displayCart(data.items || []);
      } catch (err) {
        console.error(err);
        cartContainer.innerHTML = `<p style="color:red;">Error loading cart.</p>`;
      } finally {
        loaderOverlay.style.display = 'none'; // Hide loader
      }
    }

    function displayCart(cart) {
      cartContainer.innerHTML = '';

      if (cart.length === 0) {
        cartContainer.innerHTML = `
          <div class="empty-msg">
            <p>Your cart is empty</p>
            <p class="additems" onclick="home()">Add Items</p>
          </div>`;
        subtotalEl.textContent = '₹0';
        deliveryEl.textContent = '₹0';
        totalEl.textContent = '₹0';
        checkoutBtn.disabled = true;
        return;
      }

      let subtotal = 0;

      cart.forEach((item) => {
        const price = Number(item.price) || 0;
        const qty = Number(item.qty || 1);
        const itemTotal = price * qty;
        subtotal += itemTotal;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.innerHTML = `
            <img src="${item.image || 'Assets/placeholder.png'}" alt="${item.name}">
    
            <div class="name-details">
              <h3>${item.name}</h3>
              <p class="price">₹${price}</p>
            </div>
            <div class="extra-details">
              <button onclick="removeItem('${item.productId}')"
                style="background:#f97316;color:white;border:none;
                padding:6px 12px;border-radius:6px;cursor:pointer;">
                Remove
              </button>
              <div class="qty-controls">
                <button onclick="updateQty('${item.productId}', ${qty - 1})">-</button>
                <span>${qty}</span>
                <button onclick="updateQty('${item.productId}', ${qty + 1})">+</button>
              </div>
            </div>
        `;
        cartContainer.appendChild(itemDiv);
      });

      subtotalEl.textContent = `₹${subtotal}`;
      deliveryEl.textContent = `₹0`;
      totalEl.textContent = `₹${subtotal}`;
      checkoutBtn.disabled = subtotal === 0;
    }



    checkoutBtn.addEventListener("click",()=>{
      if(!checkoutBtn.disabled){
        window.location.href="payment.html";
      }
    });


    async function updateQty(productId, qty) {
      if (qty <= 0) return;
      loaderOverlay.style.display = 'flex';
      try {
        const res = await fetch('https://dab-1.onrender.com/api/cart', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ productId, qty })
        });
        const data = await res.json();
        if (data.success) displayCart(data.cart);
      } catch (err) {
        console.error(err);
      } finally {
        loaderOverlay.style.display = 'none';
      }
    }

    async function removeItem(productId) {
      loaderOverlay.style.display = 'flex';
      try {
        const res = await fetch('https://dab-1.onrender.com/api/cart', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ productId })
        });
        const data = await res.json();
        if (data.success) displayCart(data.cart);
      } catch (err) {
        console.error(err);
      } finally {
        loaderOverlay.style.display = 'none';
      }
    }

    function home() {
      window.location.replace("index.html");
    }

    function signin(){
      window.location.href="signin.html";
    }

    loadCart();
  </script>
</body>
</html>
